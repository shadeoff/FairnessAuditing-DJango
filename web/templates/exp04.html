<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>寻找系统中的不公平样本</title>

    <!-- Mobile Specific Metas
  ================================================== -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Construction Html5 Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name=author content="Themefisher">
    <meta name=generator content="Themefisher Constra HTML Template v1.0">


    <!-- Template styles -->
    <link rel="stylesheet" href="../static/css/style.css">

    <!-- element-ui 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- ============== js ================= -->
    <!-- vue.js -->
    <script src="../static/js/vue.js"></script>

    <!-- axios.js -->
    <script src="../static/plugins/axios/axios-0.18.0.js"></script>

    <!-- element-ui 组件库 -->
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

</head>

<body>
<div class="body-inner" id="app">

    <el-container>
        <!-- Header -->
        <el-header>
            <h4>审计步骤3：寻找系统中的不公平样本</h4>
        </el-header>

        <!-- Main -->
        <el-main>
            <div class="task-area">
                <div class="task-title">
                    <h1>寻找系统中的不公平样本</h1>
                </div>
                <div class="task-content">
                    <el-row :gutter="40">
                        {#---------form1-----------------#}
                        <el-col :span="12">
                            <h4 style="margin-top: 0">样本1</h4>
                            <div class="form-card">
                                <el-form :model="form1" :rules="rules" ref="form1" label-width="148px"
                                         hide-required-asterisk="true">
                                    <div class="form-edit-area">
                                        <el-row :gutter="30">
                                            <el-col :span="12">
                                                <el-form-item
                                                        :label="'年龄 (' + default_scope.age[0] + ',' + default_scope.age[1] + ')'"
                                                        prop="age">
                                                    <el-input v-model.number="form1['age']" @change="result1='';submit1_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'每周工作时长 (' + default_scope['hours-per-week'][0] + ',' + default_scope['hours-per-week'][1] + ')'"
                                                        prop="hours-per-week">
                                                    <el-input v-model.number="form1['hours-per-week']" @change="result1='';submit1_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'受教育时长 (' + default_scope['education-num'][0] + ',' + default_scope['education-num'][1] + ')'"
                                                        prop="education-num">
                                                    <el-input v-model.number="form1['education-num']" @change="result1='';submit1_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'资产收益 (' + default_scope['capital-gain'][0] + ',' + default_scope['capital-gain'][1] + ')'"
                                                        prop="capital-gain">
                                                    <el-input v-model.number="form1['capital-gain']" @change="result1='';submit1_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'资产损失 (' + default_scope['capital-loss'][0] + ',' + default_scope['capital-loss'][1] + ')'"
                                                        prop="capital-loss">
                                                    <el-input v-model.number="form1['capital-loss']" @change="result1='';submit1_flag=false"></el-input>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">

                                                <el-form-item label="是否为白人" prop="race_White">
                                                    <el-select v-model="form1['race_White']" placeholder="请选择" @change="result1='';submit1_flag=false">
                                                        <el-option
                                                                v-for="item in filteredRace"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="性别" prop="sex_Male">
                                                    <el-select v-model="form1['sex_Male']" placeholder="请选择性别" @change="result1='';submit1_flag=false">
                                                        <el-option
                                                                v-for="item in filteredSex"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="婚姻状况" prop="marital-status">
                                                    <el-select v-model="form1['marital-status']" placeholder="请选择" @change="result1='';submit1_flag=false">
                                                        <el-option
                                                                v-for="item in filteredMaritalStatus"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="工作类型" prop="workclass">
                                                    <el-select v-model="form1['workclass']" placeholder="请选择" @change="result1='';submit1_flag=false">
                                                        <el-option
                                                                v-for="item in filteredWorkclass"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                    </div>

                                    <div class="form-submit-area">
                                        <el-row :gutter="10">
                                            <el-col :span="12">
                                                <el-form-item>
                                                    <el-button type="primary" @click="submitForm1('form1')">查询
                                                    </el-button>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <div style="float: left;">
                                                    <span>分类结果为：</span><span v-loading="loading1" :class="result_color1">[[ result1 ]]</span>
                                                </div>
                                            </el-col>
                                        </el-row>
                                    </div>
                                </el-form>
                            </div>
                        </el-col>


                        {#----------form2-------------#}

                        <el-col :span="12">
                            <h4 style="margin-top: 0">样本2</h4>
                            <div class="form-card">
                                <el-form :model="form2" :rules="rules" ref="form2" label-width="148px"
                                         hide-required-asterisk="true">
                                    <div class="form-edit-area">
                                        <el-row :gutter="30">
                                            <el-col :span="12">
                                                <el-form-item
                                                        :label="'年龄 (' + default_scope.age[0] + ',' + default_scope.age[1] + ')'"
                                                        prop="age">
                                                    <el-input v-model.number="form2['age']" @change="result2='';submit2_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'每周工作时长 (' + default_scope['hours-per-week'][0] + ',' + default_scope['hours-per-week'][1] + ')'"
                                                        prop="hours-per-week">
                                                    <el-input v-model.number="form2['hours-per-week']" @change="result2='';submit2_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'受教育时长 (' + default_scope['education-num'][0] + ',' + default_scope['education-num'][1] + ')'"
                                                        prop="education-num">
                                                    <el-input v-model.number="form2['education-num']" @change="result2='';submit2_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'资产收益 (' + default_scope['capital-gain'][0] + ',' + default_scope['capital-gain'][1] + ')'"
                                                        prop="capital-gain">
                                                    <el-input v-model.number="form2['capital-gain']" @change="result2='';submit2_flag=false"></el-input>
                                                </el-form-item>

                                                <el-form-item
                                                        :label="'资产损失 (' + default_scope['capital-loss'][0] + ',' + default_scope['capital-loss'][1] + ')'"
                                                        prop="capital-loss">
                                                    <el-input v-model.number="form2['capital-loss']" @change="result2='';submit2_flag=false"></el-input>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">

                                                <el-form-item label="是否为白人" prop="race_White">
                                                    <el-select v-model="form2['race_White']" placeholder="请选择" @change="result2='';submit2_flag=false">
                                                        <el-option
                                                                v-for="item in filteredRace"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="性别" prop="sex_Male">
                                                    <el-select v-model="form2['sex_Male']" placeholder="请选择性别" @change="result2='';submit2_flag=false">
                                                        <el-option
                                                                v-for="item in filteredSex"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="婚姻状况" prop="marital-status">
                                                    <el-select v-model="form2['marital-status']" placeholder="请选择" @change="result2='';submit2_flag=false">
                                                        <el-option
                                                                v-for="item in filteredMaritalStatus"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>

                                                <el-form-item label="工作类型" prop="workclass">
                                                    <el-select v-model="form2['workclass']" placeholder="请选择" @change="result2='';submit2_flag=false">
                                                        <el-option
                                                                v-for="item in filteredWorkclass"
                                                                :key="item.value"
                                                                :label="item.label"
                                                                :value="item.value">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                    </div>

                                    <div class="form-submit-area">
                                        <el-row :gutter="10">
                                            <el-col :span="12">
                                                <el-form-item>
                                                    <el-button type="primary" @click="submitForm2('form1')">查询
                                                    </el-button>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="12">
                                                <div style="float: left;">
                                                    <span>分类结果为：</span><span v-loading="loading2" :class="result_color2">[[ result2 ]]</span>
                                                </div>
                                            </el-col>
                                        </el-row>
                                    </div>
                                </el-form>
                            </div>
                        </el-col>

                    </el-row>


                </div>


                <div class="button-area">
                    <el-button
                            type="primary"
                            :disabled="!isFormSubmitted"
                            @click="showInfo">判定分类结果是否公平
                    </el-button>
                </div>


                {#结果#}
                <div class="result-card" v-if="show_result && isFormSubmitted">
                    <div class="result-content">
                        <span>判断两个样本被不公平对待的标准：①.分类结果1≠分类结果2；</span><span>②.样本1与样本2相似度大于等于[[ eps ]]</span>
                    </div>
                    <div class="result-content">
                        <span>当前输入样本：①分类结果1[[ comparisonSymbol ]]分类结果2； ②样本1与样本2相似度为[[ dx ]]</span><span>[[  ]]</span>
                    </div>
                    <div class="result-content">
                        <span>判断结果为</span><span>[[ fairness_info ]]</span>
                    </div>

                </div>

                <!-- 实验入口 -->
                <div class="button-area">
                    <a href="/page05/">
                        <el-button type="warning" @click="goNext">下一步</el-button>
                    </a>
                </div>

            </div>
        </el-main>

    </el-container>


</div>
<!-- 创建Vue对象 -->
<script>
    axios.get('/api/csrf/').then(response => {
        axios.defaults.headers.common['X-CSRFToken'] = response.data.csrfToken;
    });
    new Vue({
        el: "#app",
        delimiters: ["[[", "]]"],
        data() {
            return {
                //post动作
                action1: 'check_result',
                action2: 'check_fair',


                //检验是否提交了两个表单
                submit1_flag: 0,
                submit2_flag: 0,
                //敏感属性
                sensitive: '',

                form1: {
                    "age": '',
                    "capital-gain": '',
                    "capital-loss": '',
                    "education-num": '',
                    "hours-per-week": '',
                    "race_White": '',
                    "sex_Male": '',
                    "marital-status": '',
                    "workclass": '',
                },
                form2: {
                    "age": '',
                    "capital-gain": '',
                    "capital-loss": '',
                    "education-num": '',
                    "hours-per-week": '',
                    "race_White": '',
                    "sex_Male": '',
                    "marital-status": '',
                    "workclass": '',

                },
                default_scope: {
                    "age": [17, 90],
                    "capital-gain": [0, 99999],
                    "capital-loss": [0, 4356],
                    "education-num": [1, 16],
                    "hours-per-week": [1, 99],
                    "marital-status": [],
                    "workclass": [],
                    "sex_Male": [0, 1],
                    "race_White": [0, 1],

                },
                {# 婚姻状况 #}
                marital_status: [
                    {value: 'Divorced', label: '离异'},
                    {value: 'Married-AF-spouse', label: '军人家属婚姻'},
                    {value: 'Married-civ-spouse', label: '普通婚姻'},
                    {value: 'Married-spouse-absent', label: '已婚但夫妻异地'},
                    {value: 'Never-married', label: '未婚'},
                    {value: 'Separated', label: '分居'},
                    {value: 'Widowed', label: '丧偶'},],
                {# 工作类型 #}
                workclass: [
                    {value: 'Federal-gov', label: '联邦政府雇员'},
                    {value: 'Local-gov', label: '地方政府雇员'},
                    {value: 'Private', label: '私营企业'},
                    {value: 'Self-emp-inc', label: '自雇（收入较高）'},
                    {value: 'Self-emp-not-inc', label: '自雇（收入一般）'},
                    {value: 'State-gov', label: '州政府雇员'},
                    {value: 'Without-pay', label: '无报酬'},

                ],
                sex_Male: [
                    {value: 0, label: '女性'},
                    {value: 1, label: '男性'},

                ],
                race_White: [
                    {value: 0, label: '非白人'},
                    {value: 1, label: '白人'},

                ],
                target: '待填写',

                result1: ' ',
                result2: ' ',
                dx: ' ',
                dy: ' ',
                fairness_info: ' ',
                // 差异度
                eps: ' ',
                rules: {},
                loading1: false,
                result_color1: 'red',
                loading2: false,
                result_color2: 'red',
                show_result: false
            };
        },
        computed: {
            filteredMaritalStatus() {
                return this.marital_status.filter(item => this.default_scope['marital-status'].includes(item.value));
            },
            filteredWorkclass() {
                return this.workclass.filter(item => this.default_scope.workclass.includes(item.value));
            },
            filteredSex() {
                return this.sex_Male.filter(item => this.default_scope.sex_Male.includes(item.value));
            },
            filteredRace() {
                return this.race_White.filter(item => this.default_scope.race_White.includes(item.value));
            },
            {#检测表单是否均提交#}
            isFormSubmitted() {
                return this.submit1_flag === 1 && this.submit2_flag === 1;
            },
            buttonText() {
                return this.isFormSubmitted ? "查询" : "请先输入样本对信息";
            },
            comparisonSymbol() {
                return this.dy == 1 ? '≠' : '=';
            }

        },

        created() {
            this.fetchData();
        },
        mounted() {

        },
        methods: {
            //初始化时获取数据
            fetchData() {
                let _this = this;
                axios.get("/api/exp04/").then(resp => {

                    _this.default_scope = resp.data.range;
                    _this.sensitive = resp.data.sensitive_attr;
                    _this.generateRules();
                    _this.$nextTick(() => {
                        _this.$refs.form1.resetFields();
                        _this.$refs.form2.resetFields();
                    });

                });
            },
            // 构造规则
            generateRules() {
                const scope = this.default_scope;
                this.rules = {
                    age: [
                        {required: true, message: '请输入年龄', trigger: 'blur'},
                        {type: 'number', message: '年龄必须是数字值', trigger: 'blur'},
                        {
                            type: 'number',
                            min: scope.age[0],
                            max: scope.age[1],
                            message: `年龄必须在${scope.age[0]}到${scope.age[1]}之间`,
                            trigger: 'blur'
                        }
                    ],
                    'hours-per-week': [
                        {required: true, message: '请输入每周工作时长', trigger: 'blur'},
                        {type: 'number', message: '工作时长必须是数字值', trigger: 'blur'},
                        {
                            type: 'number',
                            min: scope['hours-per-week'][0],
                            max: scope['hours-per-week'][1],
                            message: `工作时长必须在${scope['hours-per-week'][0]}到${scope['hours-per-week'][1]}之间`,
                            trigger: 'blur'
                        }
                    ],
                    'education-num': [
                        {required: true, message: '请输入受教育时长', trigger: 'blur'},
                        {type: 'number', message: '受教育时长必须是数字值', trigger: 'blur'},
                        {
                            type: 'number',
                            min: scope['education-num'][0],
                            max: scope['education-num'][1],
                            message: `受教育时长必须在${scope['education-num'][0]}到${scope['education-num'][1]}之间`,
                            trigger: 'blur'
                        }
                    ],
                    'capital-gain': [
                        {required: true, message: '请输入资产收益', trigger: 'blur'},
                        {type: 'number', message: '资产收益必须是数字值', trigger: 'blur'},
                        {
                            type: 'number',
                            min: scope['capital-gain'][0],
                            max: scope['capital-gain'][1],
                            message: `资产收益必须在${scope['capital-gain'][0]}到${scope['capital-gain'][1]}之间`,
                            trigger: 'blur'
                        }
                    ],
                    'capital-loss': [
                        {required: true, message: '请输入资产损失', trigger: 'blur'},
                        {type: 'number', message: '资产损失必须是数字值', trigger: 'blur'},
                        {
                            type: 'number',
                            min: scope['capital-loss'][0],
                            max: scope['capital-loss'][1],
                            message: `资产损失必须在${scope['capital-loss'][0]}到${scope['capital-loss'][1]}之间`,
                            trigger: 'blur'
                        }
                    ],
                    'race_White': [
                        {required: true, message: '请选择是否为白人', trigger: 'change'}
                    ],
                    'sex_Male': [
                        {required: true, message: '请选择性别', trigger: 'change'}
                    ],
                    'marital-status': [
                        {required: true, message: '请选择婚姻状况', trigger: 'change'}
                    ],
                    'workclass': [
                        {required: true, message: '请选择工作类型', trigger: 'change'}
                    ]
                };
            },
            submitForm1(formName) {
                this.show_result=false
                this.loading1 = true;
                  setTimeout(() => {
                    this.loading1 = false;
                  }, 200);
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        let form = this.form1;
                        axios.post("/api/exp04/", {action: this.action1, data: form}).then(response => {
                            this.result1 = response.data;
                            this.submit1_flag = 1;
                            // this.$message({
                            //     type: 'success',
                            //     message: '查询完成！'
                            // });
                            if (this.result1 == '年收入低于50K') {
                              this.result_color1 = 'red'
                            } else {
                              this.result_color1 = 'green'
                            }
                        }).catch(error => {
                            console.log(error);
                            this.$message.error('查询失败');
                        });


                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },
            submitForm2(formName) {
                this.show_result=false
                this.loading2 = true;
                  setTimeout(() => {
                    this.loading2 = false;
                  }, 200);
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        let form = this.form2;
                        axios.post("/api/exp04/", {action: this.action1, data: form}).then(response => {
                            this.result2 = response.data;
                            this.submit2_flag = 1;
                            // this.$message({
                            //     type: 'success',
                            //     message: '查询完成！'
                            // });
                            if (this.result2 == '年收入低于50K') {
                              this.result_color2 = 'red'
                            } else {
                              this.result_color2 = 'green'
                            }
                        }).catch(error => {
                            console.log(error);
                            this.$message.error('查询失败');
                        });

                        {#alert('submit!');#}
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },

            {# 展示公平信息 #}
            showInfo() {
                if (this.isFormSubmitted) {
                    let action_attr = this.action2
                    let data1 = this.form1
                    let data2 = this.form2
                    let _this = this;
                    axios.post("/api/exp04/", {action: action_attr, data1: data1, data2: data2})
                        .then(response => {
                            console.log(response.data)
                            _this.dx = response.data.dx;
                            _this.dy = response.data.dy;
                            _this.eps = response.data.eps;
                            if (response.data.fair_or_not) {
                                _this.fairness_info = "公平";
                            } else {
                                _this.fairness_info = "不公平";
                            }
                        });
                    console.log(_this.fairness_info)
                    console.log('dx is' + _this.dx)
                    console.log(_this.eps)
                    // this.$message({
                    //     type: 'success',
                    //     message: '查询完成！'
                    // });
                    this.show_result=true
                } else {
                    console.log('error submit!!');
                }
            },


            goNext() {

            }


        }
    })


</script>

<style>
    .red {
      color: red;
    }
    .green {
      color: green;
    }
   </style>
</body>

</html>