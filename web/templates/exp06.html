<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>提交不公平样本</title>

    <!-- Mobile Specific Metas
================================================== -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Construction Html5 Template">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name=author content="Themefisher">
    <meta name=generator content="Themefisher Constra HTML Template v1.0">


    <!-- Template styles -->
    <link rel="stylesheet" href="../static/css/style.css">

    <!-- element-ui 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <!-- ============== js ================= -->
    <!-- vue.js -->
    <script src="../static/js/vue.js"></script>

    <!-- axios.js -->
    <script src="../static/plugins/axios/axios-0.18.0.js"></script>

    <!-- element-ui 组件库 -->
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>


</head>

<body>
    <div class="body-inner" id="app">

        <el-container>
            <!-- Header -->
            <header class="fixed-header">
                <h2>审计步骤4：形成审计报告</h2>
            </header>

            <!-- Main -->
            <el-main>
                <div class="main-contanier">
                    <div class="task-area">
                        <div class="task-title">

                    </div>
                    <div class="task-content">
                        <div class="task-content-form">
                            <div class="task-form-area">
                                <el-row>
                                    <el-col :span="20">
                                        <div class="task-form-title">
                                            <h2>审计报告</h2>
                                        </div>
                                        <div class="form-card" v-loading="loading" element-loading-text="正在生成审计报告，大概需要一分钟~"
                                        element-loading-spinner="el-icon-loading"
                                        element-loading-background="rgba(255, 255, 255, 0.4)">
                                            <p>本次个体公平审计对象为美国成年人收入预测分类模型，审计主要关注不同[[ sensitive_attr ]]的个人是否被模型公平对待。</p>
                                            <p>本次审计关注以下范围内的样本：</p>
                                            <div>
                                                <div>
                                                    <el-row>
                                                        <el-col :span="21" :offset="1">
                                                            <el-descriptions :column="1">
                                                                <el-descriptions-item v-for="(value, key) in data_range"
                                                                    :key="key" :label="getLabel(key)">
                                                                    [[ rangeFormat(key, value) ]]
                                                                </el-descriptions-item>
                                                            </el-descriptions>
                                                        </el-col>
                                                    </el-row>
                                                </div>
                                            </div>
                                            <p>在上述数据范围中，发现不公平样本如下：</p>
                                            <div class="card-text">
                                                {# <div v-if="inFairnessPairs.length === 0">没有不公平的样本对</div>#}
                                                <div>
                                                    <el-row :gutter="20">
                                                        <el-col :span="12">
                                                            <el-descriptions title="Sample 1" :column="2">
                                                                <el-descriptions-item v-for="(value, key) in form1"
                                                                    :key="key" :label="getLabel(key)">
                                                                    [[ formatValue(key,value) ]]
                                                                </el-descriptions-item>
                                                                <el-descriptions-item label="result">
                                                                    [[ unfair_pair_judge.result[0] ]]
                                                                </el-descriptions-item>
                                                            </el-descriptions>
                                                        </el-col>
                                                        <el-col :span="12">
                                                            <el-descriptions title="Sample 2" :column="2">
                                                                <el-descriptions-item v-for="(value, key) in form2"
                                                                    :key="key" :label="getLabel(key)">
                                                                    [[ formatValue(key,value) ]]
                                                                </el-descriptions-item>
                                                                <el-descriptions-item label="result">
                                                                    [[ unfair_pair_judge.result[1] ]]
                                                                </el-descriptions-item>
                                                            </el-descriptions>
                                                        </el-col>
                                                    </el-row>
                                                </div>
                                            </div>
                                            <p>按照个体公平性要求，相似样本（基于[[ dx_measure ]]距离的差异≤[[ parameter_c ]]）的分类结果应当相同。而上述两样本差异为[[ unfair_pair_judge.fair_data.dx ]]，且模型对其分类结果不同。因而认定模型对这对样本的分类结果不公平。</p>
                                            <p>模型优化建议：建议在不公平样本附近采样得到一批样本，并将这些样本加入模型的训练数据集对模型参数进行微调。该优化可以在几乎不影响模型总体准确性表现的情况下改善模型公平性。</p>
                                            <!-- <p>经进一步审计,该对样本附近,模型的个体公平性为[[ old_individual_fairness
                                                ]]，低于模型在总体数据上的公平性表现[[ globalFairness ]]</p>

                                            <p>模型优化建议：采用[[optimization]]的优化方法</p>
                                            <br>
                                            <p>优化完成后预计的公平性表现预计为：[[ new_individual_fairness ]]</p> -->
                                        </div>
                                    </el-col>

                                        <el-col :span="4">

                                        </el-col>
                                    </el-row>
                                </div>
                            </div>
                        </div>

                        <div class="jump-area">
                            <div class="button-area">
                                <a href="/">
                                    <el-button type="warning" @click="exit">End</el-button>
                                </a>
                            </div>
                        </div>

                    </div>
                </div>

            </el-main>

        </el-container>

    </div>

    <!-- 创建Vue对象 -->
    <script>
        axios.get('/api/csrf/').then(response => {
            axios.defaults.headers.common['X-CSRFToken'] = response.data.csrfToken;
        });

        new Vue({
            el: "#app",
            delimiters: ["[[", "]]"],
            data() {
                return {
                    loading: false,
                    inFairnessPairs: [],
                    fairness: '公平',
                    optimization: 'xxx',
                    old_individual_fairness: 'be loading...',
                    new_individual_fairness: 'be loading...',
                    globalFairness: '',
                    form1: {
                        'age': '',
                        'capital-gain': '',
                        'capital-loss': '',
                        'education-num': '',
                        'hours-per-week': '',
                        'race_White': '',
                        'sex_Male': '',
                        'marital-status': '',
                        'workclass': ''
                    },
                    form2: {
                        'age': '',
                        'capital-gain': '',
                        'capital-loss': '',
                        'education-num': '',
                        'hours-per-week': '',
                        'race_White': '',
                        'sex_Male': '',
                        'marital-status': '',
                        'workclass': ''
                    },
                    labels: {
                        'age': 'age',
                        'capital-gain': 'Capital Gain',
                        'capital-loss': 'Capital Loss',
                        'education-num': 'Education Time',
                        'hours-per-week': 'Weekly Hours',
                        'race_White': 'Race',
                        'sex_Male': 'Gender',
                        'marital-status': 'Marital Status',
                        'workclass': 'Work Class'
                    },
                    maritalStatusOptions: [
                        {value: 'Divorced', label: 'Divorced'},
                        {value: 'Married-AF-spouse', label: 'Married-AF-spouse'},
                        {value: 'Married-civ-spouse', label: 'Married-civ-spouse'},
                        {value: 'Married-spouse-absent', label: 'Married-spouse-absent'},
                        {value: 'Never-married', label: 'Never-married'},
                        {value: 'Separated', label: 'Separated'},
                        {value: 'Widowed', label: 'Widowed'},
                    ],
                    workclassOptions: [
                        {value: 'Federal-gov', label: 'Federal-gov'},
                        {value: 'Local-gov', label: 'Local-gov'},
                        {value: 'Private', label: 'Private'},
                        {value: 'Self-emp-inc', label: 'Self-emp-inc'},
                        {value: 'Self-emp-not-inc', label: 'Self-emp-not-inc'},
                        {value: 'State-gov', label: 'State-gov'},
                        {value: 'Without-pay', label: 'Without-pay'},
                    ],
                    sensitive_attr: '',
                    data_range: '',
                    parameter_c: '',
                    dx_measure: '',
                    unfair_pair_judge: {
                        result: ['', ''],
                        fair_data: {
                            fair_or_not: '',
                            dx: '',
                            dy: '',
                            eps: ''
                        }
                    }
                };
            },
            created() {
                this.fetchData();
            },
            computed: {

            },
            methods: {
                getLabel(key) {
                    return this.labels[key] || key;
                },
                formatValue(key, value) {
                    if (key === "race_White") {
                        return value === 'Others' ? 'Others' : 'White';
                    } else if (key === 'sex_Male') {
                        return value === 'Male' ? 'Male' : 'Female';
                    } else if (key === 'marital-status') {
                        return this.getOptionLabel(this.maritalStatusOptions, value);
                    } else if (key === 'workclass') {
                        return this.getOptionLabel(this.workclassOptions, value);
                    } else {
                        return value;
                    }
                },
                rangeFormat(key, value) {
                    if (key === "race_White") {
                        value = value.map(item => {
                            return item === 0 ? 'Others' : 'White';
                        })
                        return value.join(', ');
                    } else if (key === 'sex_Male') {
                        value = value.map(item => {
                            return item === 1 ? 'Male' : 'Female';
                        })
                        return value.join(', ');
                    } else if (key === 'marital-status') {
                        value = value.map(item => {
                            return this.getOptionLabel(this.maritalStatusOptions, item);
                        })
                        return value.join(', ');
                    } else if (key === 'workclass') {
                        value = value.map(item => {
                            return this.getOptionLabel(this.workclassOptions, item);
                        })
                        return value.join(', ')
                    } else {
                        return value.join(' ~ ');
                    }
                    
                },
                getOptionLabel(options, value) {
                    const option = options.find(option => option.value === value);
                    return option ? option.label : value;
                },
                fetchData() {
                    this.loading = true;
                    console.log('进入前，loading = ' + this.loading);
                    axios.get("/api/exp06/").then(response => {
                        this.form1 = response.data.unfair_pair[0];
                        this.form2 = response.data.unfair_pair[1];
                        console.log(this.form1)
                        console.log(this.form2)
                        // this.old_individual_fairness = response.data.individual_fairness.toFixed(4);
                        // this.new_individual_fairness = response.data.new_individual_fairness.toFixed(4);
                        this.sensitive_attr = response.data.sensitive_attr;
                        this.data_range = response.data.data_range;
                        this.parameter_c = (1/response.data.eps).toExponential(4);
                        this.dx_measure = response.data.dx_measure
                        this.unfair_pair_judge = response.data.unfair_pair_judge
                        this.unfair_pair_judge.fair_data.dx = this.unfair_pair_judge.fair_data.dx === 0 ? 0 : (this.unfair_pair_judge.fair_data.dx).toExponential(4)
                        this.globalFairness = 0.6773
                        this.loading = false;
                        console.log('加载完成，loading = ' + this.loading);

                    }).catch(error => {
                        console.error("There was an error fetching the data:", error);
                        this.loading = false;  // 即使发生错误，也需要设置 loading 为 false
                    });
                },
                exit() {
                    alert("结束！")
                }
            }
        })


    </script>
</body>

</html>